<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NADRA Payment Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --easypaisa-color: #00a651;
            --esahulat-color: #ffaa55;
            --nadra-color: #8e44ad;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--secondary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .transaction-item {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin-bottom: 10px;
        }
        
        .summary-card {
            background-color: var(--primary-color);
            color: white;
        }
        
        .service-select {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .service-select:hover {
            transform: translateY(-2px);
        }
        
        #transactionsList {
            max-height: 400px;
            overflow-y: auto;
        }
        
        #commission {
            background-color: #fff;
        }
        
        .fee-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .badge-normal {
            background-color: #28a745;
        }
        
        .badge-urgent {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-executive {
            background-color: #dc3545;
        }
        
        .badge-custom {
            background-color: #6c757d;
        }
        
        .badge-easypaisa {
            background-color: var(--easypaisa-color);
        }
        
        .badge-esahulat {
            background-color: var(--esahulat-color);
        }
        
        .badge-nadra {
            background-color: var(--nadra-color);
        }
        
        #customServiceFields {
            display: none;
        }
        
        .age-case-option {
            display: inline-block;
            margin-right: 10px;
        }
        
        .balance-card {
            background-color: white;
            border-left: 4px solid var(--easypaisa-color);
            margin-bottom: 20px;
        }
        
        .payment-method {
            cursor: pointer;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .payment-method.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .payment-method.easypaisa.selected {
            border-color: var(--easypaisa-color);
            background-color: rgba(0, 166, 81, 0.1);
        }
        
        .payment-method.esahulat.selected {
            border-color: var(--esahulat-color);
            background-color: rgba(255, 170, 85, 0.1);
        }
        
        .payment-method.nadra.selected {
            border-color: var(--nadra-color);
            background-color: rgba(142, 68, 173, 0.1);
        }
        
        .easypaisa-balance-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--easypaisa-color);
            text-align: center;
            margin-top: 10px;
        }
        
        .easypaisa-icon {
            color: var(--easypaisa-color);
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        #reportCanvas {
            display: none;
        }
        
        .input-group-append {
            margin-left: -1px;
        }
        
        .input-group-append .btn {
            border-radius: 0 5px 5px 0;
        }
        
        /* Transfer Section */
        .transfer-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .transfer-amount {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .transfer-amount::before {
            content: "-";
        }
        
        /* Summary breakdown styles */
        .summary-breakdown {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .summary-breakdown p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .summary-breakdown .label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1><i class="fas fa-calculator me-2"></i>NADRA Payment Calculator</h1>
        <p class="mb-0">Calculate payments with Easypaisa balance tracking</p>
    </div>
    
    <div class="container">
        <!-- Easypaisa Balance Section -->
        <div class="row">
            <div class="col-md-12">
                <div class="card balance-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-mobile-alt easypaisa-icon"></i> Easypaisa Balance</h5>
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Rs.</span>
                                    <input type="number" class="form-control" id="easypaisaBalance" placeholder="Enter amount to add">
                                    <div class="input-group-append">
                                        <button class="btn btn-success" type="button" id="updateEasypaisaBalance">
                                            <i class="fas fa-plus-circle me-1"></i> Add
                                        </button>
                                        <button class="btn btn-outline-danger" type="button" id="clearEasypaisaBalance">
                                            <i class="fas fa-trash me-1"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="transfer-section">
                                    <label class="form-label">Record Money Transfer:</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number" class="form-control" id="transferAmount" placeholder="Amount transferred">
                                        <button class="btn btn-outline-primary" type="button" id="recordTransfer">
                                            <i class="fas fa-exchange-alt me-1"></i> Update
                                        </button>
                                    </div>
                                    <small class="text-muted">Use this when you transfer money via Easypaisa</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="easypaisa-balance-display">
                                    <span id="easypaisaBalanceDisplay">0.00</span>
                                </div>
                                <div id="lastTransfer" class="text-center mt-2" style="display: none;">
                                    <small class="text-muted">Payment transfer:</small>
                                    <div class="transfer-amount" id="lastTransferAmount"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Input Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Transaction</h5>
                    </div>
                    <div class="card-body">
                        <form id="transactionForm">
                            <div class="mb-3">
                                <label for="serviceSelect" class="form-label">Select Service</label>
                                <select class="form-select" id="serviceSelect" required>
                                    <option value="" selected disabled>Select service</option>
                                    <option value="NewCNIC" data-normal="400" data-urgent="1150" data-executive="2150">New CNIC</option>
                                    <option value="CNICCancellation" data-normal="1430" data-urgent="1430" data-executive="1430">CNIC Cancellation (due to death)</option>
                                    <option value="NewSmartNIC" data-normal="750" data-urgent="1500" data-executive="2500">New Smart NIC</option>
                                    <option value="CRC" data-normal="50" data-urgent="500" data-executive="500">CRC</option>
                                    <option value="FRC" data-normal="1000" data-urgent="1000" data-executive="1000">FRC</option>
                                    <option value="MSChange" data-normal="100" data-urgent="100" data-executive="100">Marital Status Change</option>
                                    <option value="AgeCase">Age Case</option>
                                    <option value="Custom">Custom Service</option>
                                </select>
                            </div>
                            
                            <!-- Quantity Field -->
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" min="1" value="1">
                            </div>
                            
                            <!-- Custom Service Fields -->
                            <div id="customServiceFields">
                                <div class="mb-3">
                                    <label for="customServiceName" class="form-label">Service Name</label>
                                    <input type="text" class="form-control" id="customServiceName" placeholder="Enter service name">
                                </div>
                                <div class="mb-3">
                                    <label for="customServiceFee" class="form-label">Service Fee</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number" class="form-control" id="customServiceFee" placeholder="Enter fee amount">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Age Case Selection -->
                            <div class="mb-3" id="ageCaseFields" style="display: none;">
                                <label class="form-label">Select Age Case Type</label>
                                <div>
                                    <div class="form-check age-case-option">
                                        <input class="form-check-input" type="radio" name="ageCaseType" id="ageCaseNormal" value="Normal" checked>
                                        <label class="form-check-label" for="ageCaseNormal">Normal</label>
                                    </div>
                                    <div class="form-check age-case-option">
                                        <input class="form-check-input" type="radio" name="ageCaseType" id="ageCaseExecutive" value="Executive">
                                        <label class="form-check-label" for="ageCaseExecutive">Executive</label>
                                    </div>
                                </div>
                                
                                <label class="form-label mt-2">Select Age Case Price</label>
                                <select class="form-select" id="ageCasePrice">
                                    <option value="1750">Rs. 1,750 (Normal)</option>
                                    <option value="2750">Rs. 2,750 (Normal)</option>
                                    <option value="3750">Rs. 3,750 (Normal)</option>
                                    <option value="5750">Rs. 5,750 (Normal)</option>
                                    <option value="3500" class="executive-option">Rs. 3,500 (Executive)</option>
                                    <option value="4500" class="executive-option">Rs. 4,500 (Executive)</option>
                                    <option value="5500" class="executive-option">Rs. 5,500 (Executive)</option>
                                    <option value="7500" class="executive-option">Rs. 7,500 (Executive)</option>
                                </select>
                            </div>
                            
                            <!-- Fee Type Selection (for standard services) -->
                            <div class="mb-3" id="feeTypeFields">
                                <label for="feeType" class="form-label">Service Type</label>
                                <select class="form-select" id="feeType">
                                    <option value="Normal">Normal</option>
                                    <option value="Urgent">Urgent</option>
                                    <option value="Executive">Executive</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="serviceFee" class="form-label">Service Fee (NADRA)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number" class="form-control" id="serviceFee" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="commission" class="form-label">Commission</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number" class="form-control" id="commission" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="totalAmount" class="form-label">Total Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rs.</span>
                                    <input type="number" class="form-control" id="totalAmount" readonly>
                                </div>
                            </div>
                            
                            <!-- Payment Method Selection -->
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="payment-method easypaisa" data-method="Easypaisa">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod" id="paymentEasypaisa" value="Easypaisa">
                                                <label class="form-check-label" for="paymentEasypaisa">
                                                    <i class="fas fa-mobile-alt me-1" style="color: var(--easypaisa-color);"></i> Easypaisa
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="payment-method esahulat selected" data-method="E-Sahulat">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod" id="paymentEsahulat" value="E-Sahulat" checked>
                                                <label class="form-check-label" for="paymentEsahulat">
                                                    <i class="fas fa-building me-1" style="color: var(--esahulat-color);"></i> E-Sahulat
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="payment-method nadra" data-method="NADRA">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod" id="paymentNadra" value="NADRA">
                                                <label class="form-check-label" for="paymentNadra">
                                                    <i class="fas fa-id-card me-1" style="color: var(--nadra-color);"></i> NADRA
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>Add Transaction
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Today's Transactions</h5>
                        <button id="clearAllBtn" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-trash me-1"></i>Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="transactionsList">
                            <p class="text-muted text-center py-4">No transactions added yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card summary-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Daily Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <h6>Total Transactions</h6>
                                <h3 id="totalTransactions">0</h3>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6>Total Service Fees</h6>
                                <h3 id="totalServiceFees">Rs. 0</h3>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6>Total Commission</h6>
                                <h3 id="totalCommission">Rs. 0</h3>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6>Total Amount</h6>
                                <h3 id="totalAmountSummary">Rs. 0</h3>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-md-4 mb-3">
                                <h6>Easypaisa Payments</h6>
                                <h3 id="totalEasypaisa">Rs. 0</h3>
                                <div class="summary-breakdown" id="easypaisaBreakdown">
                                    <p><span class="label">Actual Amount:</span> Rs. 0</p>
                                    <p><span class="label">Commission:</span> Rs. 0</p>
                                    <p><span class="label">Total:</span> Rs. 0</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6>E-Sahulat Payments</h6>
                                <h3 id="totalEsahulat">Rs. 0</h3>
                                <div class="summary-breakdown" id="esahulatBreakdown">
                                    <p><span class="label">Actual Amount:</span> Rs. 0</p>
                                    <p><span class="label">Commission:</span> Rs. 0</p>
                                    <p><span class="label">Total:</span> Rs. 0</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6>NADRA Payments</h6>
                                <h3 id="totalNadra">Rs. 0</h3>
                                <div class="summary-breakdown" id="nadraBreakdown">
                                    <p><span class="label">Actual Amount:</span> Rs. 0</p>
                                    <p><span class="label">Commission:</span> Rs. 0</p>
                                    <p><span class="label">Total:</span> Rs. 0</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <button id="generateReportBtn" class="btn btn-light">
                                <i class="fas fa-file-image me-2"></i>Download Report as Image
                            </button>
                            <button id="printReportBtn" class="btn btn-light ms-2">
                                <i class="fas fa-print me-2"></i>Print Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for report image generation -->
    <canvas id="reportCanvas" width="1200" height="1600"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let transactions = JSON.parse(localStorage.getItem('nadraTransactions')) || [];
            let easypaisaBalance = parseFloat(localStorage.getItem('easypaisaBalance')) || 0;
            let lastTransfer = JSON.parse(localStorage.getItem('lastTransfer')) || null;
            const today = new Date().toISOString().split('T')[0];

            // Clean up old data (older than 24 hours)
            function cleanOldData() {
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                
                // Clean transactions
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= twentyFourHoursAgo;
                });
                localStorage.setItem('nadraTransactions', JSON.stringify(transactions));
            }

            // Initialize balances and clean old data
            cleanOldData();
            document.getElementById('easypaisaBalanceDisplay').textContent = easypaisaBalance.toLocaleString();
            
            // Show last transfer if exists
            if (lastTransfer) {
                document.getElementById('lastTransfer').style.display = 'block';
                document.getElementById('lastTransferAmount').textContent = 'Rs. ' + lastTransfer.amount.toLocaleString();
            }

            // DOM elements
            const serviceSelect = document.getElementById('serviceSelect');
            const feeType = document.getElementById('feeType');
            const serviceFee = document.getElementById('serviceFee');
            const commission = document.getElementById('commission');
            const totalAmount = document.getElementById('totalAmount');
            const quantity = document.getElementById('quantity');
            const customServiceFields = document.getElementById('customServiceFields');
            const ageCaseFields = document.getElementById('ageCaseFields');
            const ageCasePrice = document.getElementById('ageCasePrice');
            const ageCaseNormal = document.getElementById('ageCaseNormal');
            const ageCaseExecutive = document.getElementById('ageCaseExecutive');
            const paymentMethods = document.querySelectorAll('.payment-method');

            // Payment method selection styling
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update styling
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Update Easypaisa balance (now adds to existing balance)
            document.getElementById('updateEasypaisaBalance').addEventListener('click', function() {
                const amountToAdd = parseFloat(document.getElementById('easypaisaBalance').value) || 0;
                if (amountToAdd <= 0) {
                    alert('Please enter a valid positive amount to add');
                    return;
                }
                
                easypaisaBalance += amountToAdd;
                localStorage.setItem('easypaisaBalance', easypaisaBalance);
                
                document.getElementById('easypaisaBalanceDisplay').textContent = easypaisaBalance.toLocaleString();
                document.getElementById('easypaisaBalance').value = '';
                alert(`Added Rs. ${amountToAdd.toLocaleString()} to Easypaisa balance. New balance: Rs. ${easypaisaBalance.toLocaleString()}`);
            });

            // Record a transfer (when you transfer money to someone via Easypaisa)
            document.getElementById('recordTransfer').addEventListener('click', function() {
                const transferAmount = parseFloat(document.getElementById('transferAmount').value) || 0;
                if (transferAmount <= 0) {
                    alert('Please enter a valid positive transfer amount');
                    return;
                }
                
                if (transferAmount > easypaisaBalance) {
                    alert('Transfer amount cannot exceed your Easypaisa balance');
                    return;
                }
                
                easypaisaBalance -= transferAmount;
                localStorage.setItem('easypaisaBalance', easypaisaBalance);
                
                // Store last transfer
                lastTransfer = {
                    date: new Date().toISOString(),
                    amount: transferAmount
                };
                localStorage.setItem('lastTransfer', JSON.stringify(lastTransfer));
                
                document.getElementById('easypaisaBalanceDisplay').textContent = easypaisaBalance.toLocaleString();
                document.getElementById('transferAmount').value = '';
                
                // Show last transfer
                document.getElementById('lastTransfer').style.display = 'block';
                document.getElementById('lastTransferAmount').textContent = 'Rs. ' + transferAmount.toLocaleString();
                
                alert(`Recorded transfer of Rs. ${transferAmount.toLocaleString()}. New balance: Rs. ${easypaisaBalance.toLocaleString()}`);
            });

            // Clear Easypaisa balance
            document.getElementById('clearEasypaisaBalance').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the Easypaisa balance?')) {
                    easypaisaBalance = 0;
                    localStorage.setItem('easypaisaBalance', easypaisaBalance);
                    document.getElementById('easypaisaBalanceDisplay').textContent = '0';
                    document.getElementById('easypaisaBalance').value = '';
                    
                    // Clear last transfer
                    lastTransfer = null;
                    localStorage.removeItem('lastTransfer');
                    document.getElementById('lastTransfer').style.display = 'none';
                    
                    alert('Easypaisa balance has been cleared');
                }
            });

            // When service changes, update the form fields
            serviceSelect.addEventListener('change', function() {
                const selectedService = this.value;
                
                // Hide all special fields first
                customServiceFields.style.display = 'none';
                ageCaseFields.style.display = 'none';
                feeTypeFields.style.display = 'block';
                
                // Reset fields
                serviceFee.value = '';
                commission.value = '';
                totalAmount.value = '';
                quantity.value = 1;
                
                if (selectedService === 'Custom') {
                    customServiceFields.style.display = 'block';
                    feeTypeFields.style.display = 'none';
                } 
                else if (selectedService === 'AgeCase') {
                    ageCaseFields.style.display = 'block';
                    feeTypeFields.style.display = 'none';
                    updateAgeCaseOptions();
                }
                else {
                    // For standard services, update the fee based on selected type
                    updateFee();
                }
            });

            // Update Age Case options based on Normal/Executive selection
            function updateAgeCaseOptions() {
                const isExecutive = ageCaseExecutive.checked;
                const options = ageCasePrice.options;
                
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    const isExecutiveOption = option.classList.contains('executive-option');
                    
                    if (isExecutive) {
                        option.style.display = isExecutiveOption ? '' : 'none';
                    } else {
                        option.style.display = isExecutiveOption ? 'none' : '';
                    }
                }
                
                // Set the first visible option as selected
                for (let i = 0; i < options.length; i++) {
                    if (options[i].style.display !== 'none') {
                        ageCasePrice.value = options[i].value;
                        break;
                    }
                }
                
                // Update the service fee field
                serviceFee.value = ageCasePrice.value;
                commission.value = '';
                totalAmount.value = '';
                commission.focus();
            }

            // When Age Case type changes
            ageCaseNormal.addEventListener('change', updateAgeCaseOptions);
            ageCaseExecutive.addEventListener('change', updateAgeCaseOptions);
            
            // When Age Case price changes
            ageCasePrice.addEventListener('change', function() {
                serviceFee.value = this.value;
                commission.value = '';
                totalAmount.value = '';
            });

            // When fee type changes, update fee
            feeType.addEventListener('change', updateFee);

            // When quantity changes, update total
            quantity.addEventListener('input', function() {
                updateTotalAmount();
            });

            // When commission changes, update total
            commission.addEventListener('input', function() {
                updateTotalAmount();
            });

            function updateTotalAmount() {
                const serviceFeeVal = parseFloat(serviceFee.value) || 0;
                const commissionVal = parseFloat(commission.value) || 0;
                const quantityVal = parseInt(quantity.value) || 1;
                totalAmount.value = (serviceFeeVal + commissionVal) * quantityVal;
            }

            function updateFee() {
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const selectedFeeType = feeType.value.toLowerCase();
                
                if (selectedOption && selectedOption.value && selectedOption.value !== 'Custom' && selectedOption.value !== 'AgeCase') {
                    const fee = selectedOption.getAttribute(`data-${selectedFeeType}`);
                    if (fee && fee !== "null") {
                        serviceFee.value = fee;
                        commission.value = '';
                        updateTotalAmount();
                        commission.focus();
                    } else {
                        serviceFee.value = '';
                        alert(`This service doesn't have ${selectedFeeType} fee option`);
                    }
                }
            }

            // Add new transaction
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const selectedService = serviceSelect.value;
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const quantityVal = parseInt(quantity.value) || 1;
                
                if (!selectedService) {
                    alert('Please select a service');
                    return;
                }
                
                if (quantityVal < 1) {
                    alert('Quantity must be at least 1');
                    return;
                }
                
                // Check Easypaisa balance if paying from Easypaisa
                const serviceFeeVal = parseFloat(serviceFee.value) || 0;
                const totalServiceFee = serviceFeeVal * quantityVal;
                if (paymentMethod === 'Easypaisa' && totalServiceFee > easypaisaBalance) {
                    alert('Insufficient Easypaisa balance!');
                    return;
                }
                
                let transaction = {};
                
                if (selectedService === 'Custom') {
                    const serviceName = document.getElementById('customServiceName').value.trim();
                    const serviceFeeVal = parseFloat(document.getElementById('customServiceFee').value);
                    
                    if (!serviceName || isNaN(serviceFeeVal)) {
                        alert('Please enter valid custom service details');
                        return;
                    }
                    
                    const commissionVal = parseFloat(commission.value);
                    
                    if (isNaN(commissionVal)) {
                        alert('Please enter a valid commission amount');
                        return;
                    }
                    
                    transaction = {
                        id: Date.now(),
                        date: today,
                        serviceName: serviceName,
                        feeType: 'Custom',
                        serviceFee: serviceFeeVal,
                        commission: commissionVal,
                        quantity: quantityVal,
                        totalAmount: (serviceFeeVal + commissionVal) * quantityVal,
                        paymentMethod: paymentMethod
                    };
                } 
                else if (selectedService === 'AgeCase') {
                    const ageCaseType = ageCaseExecutive.checked ? 'Executive' : 'Normal';
                    const serviceName = `Age Case (${ageCaseType})`;
                    const serviceFeeVal = parseFloat(ageCasePrice.value);
                    const commissionVal = parseFloat(commission.value);
                    
                    if (isNaN(commissionVal)) {
                        alert('Please enter a valid commission amount');
                        return;
                    }
                    
                    transaction = {
                        id: Date.now(),
                        date: today,
                        serviceName: serviceName,
                        feeType: ageCaseType,
                        serviceFee: serviceFeeVal,
                        commission: commissionVal,
                        quantity: quantityVal,
                        totalAmount: (serviceFeeVal + commissionVal) * quantityVal,
                        paymentMethod: paymentMethod
                    };
                }
                else {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const selectedFeeType = feeType.value;
                    const serviceName = selectedOption.text;
                    const serviceFeeVal = parseFloat(serviceFee.value) || 0;
                    const commissionVal = parseFloat(commission.value) || 0;
                    
                    if (isNaN(commissionVal)) {
                        alert('Please enter a valid commission amount');
                        return;
                    }
                    
                    transaction = {
                        id: Date.now(),
                        date: today,
                        serviceName: serviceName,
                        feeType: selectedFeeType,
                        serviceFee: serviceFeeVal,
                        commission: commissionVal,
                        quantity: quantityVal,
                        totalAmount: (serviceFeeVal + commissionVal) * quantityVal,
                        paymentMethod: paymentMethod
                    };
                }
                
                // Deduct from Easypaisa balance if applicable (only service fee, not commission)
                if (paymentMethod === 'Easypaisa') {
                    easypaisaBalance -= transaction.serviceFee * transaction.quantity;
                    localStorage.setItem('easypaisaBalance', easypaisaBalance);
                    document.getElementById('easypaisaBalanceDisplay').textContent = easypaisaBalance.toLocaleString();
                }
                
                // Add single transaction with quantity instead of multiple entries
                transactions.push(transaction);
                
                saveTransactions();
                updateTransactionsList();
                updateSummary();
                
                // Reset form
                this.reset();
                serviceSelect.value = '';
                serviceFee.value = '';
                commission.value = '';
                totalAmount.value = '';
                quantity.value = 1;
                feeType.value = 'Normal';
                customServiceFields.style.display = 'none';
                ageCaseFields.style.display = 'none';
                ageCaseNormal.checked = true;
                updateAgeCaseOptions();
                document.getElementById('paymentEsahulat').checked = true;
                document.querySelector('.payment-method.esahulat').classList.add('selected');
                document.querySelector('.payment-method.nadra').classList.remove('selected');
                document.querySelector('.payment-method.easypaisa').classList.remove('selected');
            });

            // Clear all transactions
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all transactions?')) {
                    transactions = [];
                    saveTransactions();
                    updateTransactionsList();
                    updateSummary();
                }
            });

            // Generate report as image
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                generateImageReport();
            });

            // Print report
            document.getElementById('printReportBtn').addEventListener('click', function() {
                printReport();
            });

            // Save transactions to localStorage
            function saveTransactions() {
                localStorage.setItem('nadraTransactions', JSON.stringify(transactions));
            }

            // Update transactions list
            function updateTransactionsList() {
                const transactionsList = document.getElementById('transactionsList');
                
                if (transactions.length === 0) {
                    transactionsList.innerHTML = '<p class="text-muted text-center py-4">No transactions added yet</p>';
                    return;
                }
                
                // Filter today's transactions
                const todaysTransactions = transactions.filter(t => t.date === today);
                
                if (todaysTransactions.length === 0) {
                    transactionsList.innerHTML = '<p class="text-muted text-center py-4">No transactions for today</p>';
                    return;
                }
                
                let html = '';
                todaysTransactions.forEach(transaction => {
                    let badgeClass = '';
                    if (transaction.feeType === 'Normal') badgeClass = 'badge-normal';
                    if (transaction.feeType === 'Urgent') badgeClass = 'badge-urgent';
                    if (transaction.feeType === 'Executive') badgeClass = 'badge-executive';
                    if (transaction.feeType === 'Custom') badgeClass = 'badge-custom';
                    
                    let paymentBadgeClass = '';
                    let paymentIcon = '';
                    if (transaction.paymentMethod === 'Easypaisa') {
                        paymentBadgeClass = 'badge-easypaisa';
                        paymentIcon = 'fa-mobile-alt';
                    } else if (transaction.paymentMethod === 'E-Sahulat') {
                        paymentBadgeClass = 'badge-esahulat';
                        paymentIcon = 'fa-building';
                    } else if (transaction.paymentMethod === 'NADRA') {
                        paymentBadgeClass = 'badge-nadra';
                        paymentIcon = 'fa-id-card';
                    }
                    
                    html += `
                        <div class="transaction-item">
                            <div class="d-flex justify-content-between">
                                <strong>${transaction.serviceName} ${transaction.quantity > 1 ? `(x${transaction.quantity})` : ''}</strong>
                                <span class="text-danger">Rs. ${transaction.totalAmount.toLocaleString()}</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <div>
                                    <span class="fee-type-badge ${badgeClass}">${transaction.feeType}</span>
                                    <span class="fee-type-badge ${paymentBadgeClass} ms-1">
                                        <i class="fas ${paymentIcon} me-1"></i>${transaction.paymentMethod}
                                    </span>
                                </div>
                                <span>Fee: Rs. ${transaction.serviceFee.toLocaleString()} + Commission: Rs. ${transaction.commission.toLocaleString()}</span>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${transaction.id}" data-amount="${transaction.serviceFee}" data-method="${transaction.paymentMethod}" data-quantity="${transaction.quantity}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <hr>
                        </div>
                    `;
                });
                
                transactionsList.innerHTML = html;
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const amount = parseFloat(this.getAttribute('data-amount'));
                        const method = this.getAttribute('data-method');
                        const quantity = parseInt(this.getAttribute('data-quantity')) || 1;
                        
                        if (confirm('Are you sure you want to delete this transaction?')) {
                            // Return amount to Easypaisa balance if applicable
                            if (method === 'Easypaisa') {
                                easypaisaBalance += amount * quantity;
                                localStorage.setItem('easypaisaBalance', easypaisaBalance);
                                document.getElementById('easypaisaBalanceDisplay').textContent = easypaisaBalance.toLocaleString();
                            }
                            
                            transactions = transactions.filter(t => t.id !== id);
                            saveTransactions();
                            updateTransactionsList();
                            updateSummary();
                        }
                    });
                });
            }

            // Update summary
            function updateSummary() {
                const todaysTransactions = transactions.filter(t => t.date === today);
                
                const totalTransactions = todaysTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0);
                const totalServiceFees = todaysTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalCommission = todaysTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalAmount = totalServiceFees + totalCommission;
                
                const easypaisaTransactions = todaysTransactions.filter(t => t.paymentMethod === 'Easypaisa');
                const totalEasypaisaServiceFee = easypaisaTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEasypaisaCommission = easypaisaTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEasypaisa = totalEasypaisaServiceFee + totalEasypaisaCommission;
                
                const esahulatTransactions = todaysTransactions.filter(t => t.paymentMethod === 'E-Sahulat');
                const totalEsahulatServiceFee = esahulatTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEsahulatCommission = esahulatTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEsahulat = totalEsahulatServiceFee + totalEsahulatCommission;
                
                const nadraTransactions = todaysTransactions.filter(t => t.paymentMethod === 'NADRA');
                const totalNadraServiceFee = nadraTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalNadraCommission = nadraTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalNadra = totalNadraServiceFee + totalNadraCommission;
                
                // Update main summary
                document.getElementById('totalTransactions').textContent = totalTransactions;
                document.getElementById('totalServiceFees').textContent = `Rs. ${totalServiceFees.toLocaleString()}`;
                document.getElementById('totalCommission').textContent = `Rs. ${totalCommission.toLocaleString()}`;
                document.getElementById('totalAmountSummary').textContent = `Rs. ${totalAmount.toLocaleString()}`;
                
                // Update payment method summaries with breakdowns
                document.getElementById('totalEasypaisa').textContent = `Rs. ${totalEasypaisa.toLocaleString()}`;
                document.getElementById('easypaisaBreakdown').innerHTML = `
                    <p><span class="label">Actual Amount:</span> Rs. ${totalEasypaisaServiceFee.toLocaleString()}</p>
                    <p><span class="label">Commission:</span> Rs. ${totalEasypaisaCommission.toLocaleString()}</p>
                    <p><span class="label">Total:</span> Rs. ${totalEasypaisa.toLocaleString()}</p>
                `;
                
                document.getElementById('totalEsahulat').textContent = `Rs. ${totalEsahulat.toLocaleString()}`;
                document.getElementById('esahulatBreakdown').innerHTML = `
                    <p><span class="label">Actual Amount:</span> Rs. ${totalEsahulatServiceFee.toLocaleString()}</p>
                    <p><span class="label">Commission:</span> Rs. ${totalEsahulatCommission.toLocaleString()}</p>
                    <p><span class="label">Total:</span> Rs. ${totalEsahulat.toLocaleString()}</p>
                `;
                
                document.getElementById('totalNadra').textContent = `Rs. ${totalNadra.toLocaleString()}`;
                document.getElementById('nadraBreakdown').innerHTML = `
                    <p><span class="label">Actual Amount:</span> Rs. ${totalNadraServiceFee.toLocaleString()}</p>
                    <p><span class="label">Commission:</span> Rs. ${totalNadraCommission.toLocaleString()}</p>
                    <p><span class="label">Total:</span> Rs. ${totalNadra.toLocaleString()}</p>
                `;
            }

            // Generate image report
            function generateImageReport() {
                const todaysTransactions = transactions.filter(t => t.date === today);
                
                // Group transactions by service, fee type, and payment method
                const groupedTransactions = {};
                
                todaysTransactions.forEach(t => {
                    const key = `${t.serviceName}|${t.feeType}|${t.paymentMethod}`;
                    if (!groupedTransactions[key]) {
                        groupedTransactions[key] = {
                            serviceName: t.serviceName,
                            feeType: t.feeType,
                            paymentMethod: t.paymentMethod,
                            count: 0,
                            totalServiceFee: 0,
                            totalCommission: 0,
                            totalAmount: 0
                        };
                    }
                    
                    groupedTransactions[key].count += (t.quantity || 1);
                    groupedTransactions[key].totalServiceFee += t.serviceFee * (t.quantity || 1);
                    groupedTransactions[key].totalCommission += t.commission * (t.quantity || 1);
                    groupedTransactions[key].totalAmount += t.totalAmount;
                });
                
                // Convert to array
                const summaryData = Object.values(groupedTransactions);
                
                const totalTransactions = todaysTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0);
                const totalServiceFees = todaysTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalCommission = todaysTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalAmount = totalServiceFees + totalCommission;
                
                const easypaisaTransactions = todaysTransactions.filter(t => t.paymentMethod === 'Easypaisa');
                const totalEasypaisaServiceFee = easypaisaTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEasypaisaCommission = easypaisaTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEasypaisa = totalEasypaisaServiceFee + totalEasypaisaCommission;
                
                const esahulatTransactions = todaysTransactions.filter(t => t.paymentMethod === 'E-Sahulat');
                const totalEsahulatServiceFee = esahulatTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEsahulatCommission = esahulatTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEsahulat = totalEsahulatServiceFee + totalEsahulatCommission;
                
                const nadraTransactions = todaysTransactions.filter(t => t.paymentMethod === 'NADRA');
                const totalNadraServiceFee = nadraTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalNadraCommission = nadraTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalNadra = totalNadraServiceFee + totalNadraCommission;
                
                // Create HTML for the report
                const reportHTML = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: white;">
                        <h1 style="color: #2c3e50; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                            NADRA Payment Report
                        </h1>
                        <h3 style="text-align: center; color: #555;">${today}</h3>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background-color: #3498db; color: white;">
                                    <th style="padding: 10px; text-align: left;">#</th>
                                    <th style="padding: 10px; text-align: left;">Service</th>
                                    <th style="padding: 10px; text-align: left;">Type</th>
                                    <th style="padding: 10px; text-align: left;">Payment</th>
                                    <th style="padding: 10px; text-align: left;">Count</th>
                                    <th style="padding: 10px; text-align: left;">Total Fee</th>
                                    <th style="padding: 10px; text-align: left;">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summaryData.map((item, index) => {
                                    const typeColor = item.feeType === 'Normal' ? '#28a745' : 
                                                     item.feeType === 'Urgent' ? '#ffc107' : 
                                                     item.feeType === 'Executive' ? '#dc3545' : '#6c757d';
                                    const paymentColor = item.paymentMethod === 'Easypaisa' ? '#00a651' : 
                                                        item.paymentMethod === 'E-Sahulat' ? '#0056b3' : 
                                                        '#8e44ad';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #ddd;">
                                            <td style="padding: 10px;">${index + 1}</td>
                                            <td style="padding: 10px;">${item.serviceName}</td>
                                            <td style="padding: 10px;">
                                                <span style="background-color: ${typeColor}; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em;">
                                                    ${item.feeType}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; color: ${paymentColor}">
                                                ${item.paymentMethod}
                                            </td>
                                            <td style="padding: 10px;">${item.count}</td>
                                            <td style="padding: 10px;">Rs. ${item.totalServiceFee.toLocaleString()}</td>
                                            <td style="padding: 10px;">Rs. ${item.totalAmount.toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <div style="width: 32%; padding: 15px; border-radius: 5px; border: 1px solid #00a651; background-color: rgba(0, 166, 81, 0.1);">
                                <h3 style="color: #00a651; margin-top: 0;">Easypaisa Summary</h3>
                                <p><strong>Total Transactions:</strong> ${easypaisaTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalEasypaisaServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalEasypaisaCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Deducted:</strong> Rs. ${totalEasypaisa.toLocaleString()}</p>
                                ${lastTransfer ? `<p><strong>Last Transfer:</strong> <span style="color: #e74c3c;">Rs. ${lastTransfer.amount.toLocaleString()}</span></p>` : ''}
                                <p><strong>Remaining Balance:</strong> Rs. ${easypaisaBalance.toLocaleString()}</p>
                            </div>
                            <div style="width: 32%; padding: 15px; border-radius: 5px; border: 1px solid #0056b3; background-color: rgba(0, 86, 179, 0.1);">
                                <h3 style="color: #0056b3; margin-top: 0;">E-Sahulat Summary</h3>
                                <p><strong>Total Transactions:</strong> ${esahulatTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalEsahulatServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalEsahulatCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Collected:</strong> Rs. ${totalEsahulat.toLocaleString()}</p>
                            </div>
                            <div style="width: 32%; padding: 15px; border-radius: 5px; border: 1px solid #8e44ad; background-color: rgba(142, 68, 173, 0.1);">
                                <h3 style="color: #8e44ad; margin-top: 0;">NADRA Summary</h3>
                                <p><strong>Total Transactions:</strong> ${nadraTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalNadraServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalNadraCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Collected:</strong> Rs. ${totalNadra.toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">
                            <h3 style="margin-top: 0;">Overall Summary</h3>
                            <p><strong>Total Transactions:</strong> ${totalTransactions}</p>
                            <p><strong>Total Service Fees:</strong> Rs. ${totalServiceFees.toLocaleString()}</p>
                            <p><strong>Total Commission:</strong> Rs. ${totalCommission.toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> Rs. ${totalAmount.toLocaleString()}</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #777;">
                            <p>Generated on ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                // Create a temporary div to render the report
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHTML;
                document.body.appendChild(tempDiv);
                
                // Use html2canvas to convert to image
                html2canvas(tempDiv, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                }).then(canvas => {
                    // Convert canvas to image and download
                    const link = document.createElement('a');
                    link.download = `NADRA-Report-${today}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Remove temporary div
                    document.body.removeChild(tempDiv);
                });
            }

            // Print report
            function printReport() {
                const todaysTransactions = transactions.filter(t => t.date === today);
                
                // Group transactions by service, fee type, and payment method
                const groupedTransactions = {};
                
                todaysTransactions.forEach(t => {
                    const key = `${t.serviceName}|${t.feeType}|${t.paymentMethod}`;
                    if (!groupedTransactions[key]) {
                        groupedTransactions[key] = {
                            serviceName: t.serviceName,
                            feeType: t.feeType,
                            paymentMethod: t.paymentMethod,
                            count: 0,
                            totalServiceFee: 0,
                            totalCommission: 0,
                            totalAmount: 0
                        };
                    }
                    
                    groupedTransactions[key].count += (t.quantity || 1);
                    groupedTransactions[key].totalServiceFee += t.serviceFee * (t.quantity || 1);
                    groupedTransactions[key].totalCommission += t.commission * (t.quantity || 1);
                    groupedTransactions[key].totalAmount += t.totalAmount;
                });
                
                // Convert to array
                const summaryData = Object.values(groupedTransactions);
                
                const totalTransactions = todaysTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0);
                const totalServiceFees = todaysTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalCommission = todaysTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalAmount = totalServiceFees + totalCommission;
                
                const easypaisaTransactions = todaysTransactions.filter(t => t.paymentMethod === 'Easypaisa');
                const totalEasypaisaServiceFee = easypaisaTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEasypaisaCommission = easypaisaTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEasypaisa = totalEasypaisaServiceFee + totalEasypaisaCommission;
                
                const esahulatTransactions = todaysTransactions.filter(t => t.paymentMethod === 'E-Sahulat');
                const totalEsahulatServiceFee = esahulatTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalEsahulatCommission = esahulatTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalEsahulat = totalEsahulatServiceFee + totalEsahulatCommission;
                
                const nadraTransactions = todaysTransactions.filter(t => t.paymentMethod === 'NADRA');
                const totalNadraServiceFee = nadraTransactions.reduce((sum, t) => sum + (t.serviceFee * (t.quantity || 1)), 0);
                const totalNadraCommission = nadraTransactions.reduce((sum, t) => sum + (t.commission * (t.quantity || 1)), 0);
                const totalNadra = totalNadraServiceFee + totalNadraCommission;
                
                let reportHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>NADRA Payment Report - ${today}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2c3e50; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #3498db; color: white; }
                            .normal { background-color: #28a745; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
                            .urgent { background-color: #ffc107; color: #212529; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
                            .executive { background-color: #dc3545; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
                            .custom { background-color: #6c757d; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
                            .easypaisa { color: #00a651; }
                            .esahulat { color: #0056b3; }
                            .nadra { color: #8e44ad; }
                            .summary { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
                            .footer { text-align: center; margin-top: 30px; font-size: 0.8em; color: #777; }
                            .payment-summary { display: flex; justify-content: space-between; margin-top: 20px; }
                            .payment-card { width: 32%; padding: 10px; border-radius: 5px; }
                            .easypaisa-card { border: 1px solid #00a651; background-color: rgba(0, 166, 81, 0.1); }
                            .esahulat-card { border: 1px solid #0056b3; background-color: rgba(0, 86, 179, 0.1); }
                            .nadra-card { border: 1px solid #8e44ad; background-color: rgba(142, 68, 173, 0.1); }
                            .transfer { color: #e74c3c; }
                            @media print {
                                body { margin: 0; padding: 20px; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>NADRA Payment Report</h1>
                        <h3 style="text-align: center;">${today}</h3>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Service</th>
                                    <th>Type</th>
                                    <th>Payment Method</th>
                                    <th>Count</th>
                                    <th>Total Fee</th>
                                    <th>Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                summaryData.forEach((item, index) => {
                    let typeClass = item.feeType.toLowerCase();
                    let paymentClass = item.paymentMethod === 'Easypaisa' ? 'easypaisa' : 
                                      item.paymentMethod === 'E-Sahulat' ? 'esahulat' : 
                                      'nadra';
                    
                    reportHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.serviceName}</td>
                            <td><span class="${typeClass}">${item.feeType}</span></td>
                            <td class="${paymentClass}">${item.paymentMethod}</td>
                            <td>${item.count}</td>
                            <td>Rs. ${item.totalServiceFee.toLocaleString()}</td>
                            <td>Rs. ${item.totalAmount.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                            </tbody>
                        </table>
                        
                        <div class="payment-summary">
                            <div class="payment-card easypaisa-card">
                                <h3>Easypaisa Summary</h3>
                                <p><strong>Total Transactions:</strong> ${easypaisaTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalEasypaisaServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalEasypaisaCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Deducted:</strong> Rs. ${totalEasypaisa.toLocaleString()}</p>
                                ${lastTransfer ? `<p><strong>Last Transfer:</strong> <span class="transfer">Rs. ${lastTransfer.amount.toLocaleString()}</span></p>` : ''}
                                <p><strong>Remaining Balance:</strong> Rs. ${easypaisaBalance.toLocaleString()}</p>
                            </div>
                            <div class="payment-card esahulat-card">
                                <h3>E-Sahulat Summary</h3>
                                <p><strong>Total Transactions:</strong> ${esahulatTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalEsahulatServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalEsahulatCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Collected:</strong> Rs. ${totalEsahulat.toLocaleString()}</p>
                            </div>
                            <div class="payment-card nadra-card">
                                <h3>NADRA Summary</h3>
                                <p><strong>Total Transactions:</strong> ${nadraTransactions.reduce((sum, t) => sum + (t.quantity || 1), 0)}</p>
                                <p><strong>Actual Amount:</strong> Rs. ${totalNadraServiceFee.toLocaleString()}</p>
                                <p><strong>Commission:</strong> Rs. ${totalNadraCommission.toLocaleString()}</p>
                                <p><strong>Total Amount Collected:</strong> Rs. ${totalNadra.toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="summary">
                            <h3>Overall Summary</h3>
                            <p><strong>Total Transactions:</strong> ${totalTransactions}</p>
                            <p><strong>Total Service Fees:</strong> Rs. ${totalServiceFees.toLocaleString()}</p>
                            <p><strong>Total Commission:</strong> Rs. ${totalCommission.toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> Rs. ${totalAmount.toLocaleString()}</p>
                        </div>
                        
                        <div class="footer">
                            <p>Generated on ${new Date().toLocaleString()}</p>
                        </div>
                        
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `;
              
                const printWindow = window.open('', '_blank');
                printWindow.document.write(reportHTML);
                printWindow.document.close();
            }

            // Initialize the app
            updateTransactionsList();
            updateSummary();
            updateAgeCaseOptions();
            
            // Set initial payment method selection
            document.querySelector('.payment-method.esahulat').classList.add('selected');
            document.querySelector('.payment-method.nadra').classList.remove('selected');
            document.querySelector('.payment-method.easypaisa').classList.remove('selected');
        });
    </script>
</body>
</html>
